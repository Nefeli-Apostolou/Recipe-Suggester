<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Suggester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .missing-ingredient {
            background-color: #FFE4E1; /* mistyrose */
            color: #8B575C;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: normal;
        }
    </style>
</head>
<body class="bg-gradient-to-r from-purple-400 via-pink-500 to-red-500">

    <div class="container mx-auto p-8">
        <h1 class="text-5xl font-bold text-center text-white mb-8 bg-clip-text text-transparent bg-gradient-to-r from-blue-200 to-purple-200">
            Recipe Suggester
        </h1>

        <div class="bg-white bg-opacity-20 p-6 rounded-lg shadow-lg mb-8 backdrop-filter backdrop-blur-lg">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="ingredients-input" placeholder="Enter ingredients (comma-separated)..." class="p-3 border border-gray-300 rounded-lg col-span-1 md:col-span-2 focus:outline-none focus:ring-2 focus:ring-pink-500">
                <button id="find-recipes-btn" class="bg-pink-500 text-white p-3 rounded-lg hover:bg-pink-600 transition-colors col-span-1">Find Recipes</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
                <select id="category-filter" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <option value="">All Categories</option>
                </select>
                <select id="diet-filter" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <option value="">All Diets</option>
                    <option value="vegetarian">Vegetarian</option>
                    <option value="non-vegetarian">Non-Vegetarian</option>
                    <option value="vegan">Vegan</option>
                </select>
                <select id="gluten-filter" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <option value="">All Gluten</option>
                    <option value="gluten-free">Gluten-Free</option>
                    <option value="contains gluten">Contains Gluten</option>
                </select>
                <select id="macro-filter" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <option value="">All Macros</option>
                    <option value="high-protein">High Protein</option>
                    <option value="low-carb">Low Carb</option>
                    <option value="low-fat">Low Fat</option>
                </select>
            </div>
        </div>

        <div id="exact-matches-container" style="display: none;">
            <h2 class="text-3xl font-bold text-white mb-4">Exact Matches</h2>
            <div id="exact-matches-recipes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            <div id="exact-matches-pagination" class="flex justify-center items-center mt-8 text-white"></div>
        </div>
        <div id="almost-matches-container" class="mt-12" style="display: none;">
            <h2 class="text-3xl font-bold text-white mb-4">Almost Matches</h2>
            <div id="almost-matches-recipes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            <div id="almost-matches-pagination" class="flex justify-center items-center mt-8 text-white"></div>
        </div>

    </div>

    <script>
        let recipes = [];
        let exactMatchesCurrentPage = 1;
        let almostMatchesCurrentPage = 1;
        const recipesPerPage = 20;
        let currentExactMatches = [];
        let currentAlmostMatches = [];

        const ingredientsInput = document.getElementById('ingredients-input');
        const findRecipesBtn = document.getElementById('find-recipes-btn');
        const categoryFilter = document.getElementById('category-filter');
        const dietFilter = document.getElementById('diet-filter');
        const glutenFilter = document.getElementById('gluten-filter');
        const macroFilter = document.getElementById('macro-filter');
        const exactMatchesContainer = document.getElementById('exact-matches-recipes');
        const almostMatchesContainer = document.getElementById('almost-matches-recipes');
        const exactMatchesContainerDiv = document.getElementById('exact-matches-container');
        const almostMatchesContainerDiv = document.getElementById('almost-matches-container');
        const exactMatchesPagination = document.getElementById('exact-matches-pagination');
        const almostMatchesPagination = document.getElementById('almost-matches-pagination');

        const categoryColors = {
            diet: {
                vegetarian: 'bg-green-200 text-green-800',
                'non-vegetarian': 'bg-red-200 text-red-800',
                vegan: 'bg-blue-200 text-blue-800'
            },
            gluten: {
                'gluten-free': 'bg-indigo-200 text-indigo-800',
                'contains gluten': 'bg-purple-200 text-purple-800'
            }
        };
        
        function parseInstructions(instructions) {
            if (typeof instructions !== 'string') {
                return [];
            }
            let cleaned = instructions.trim();
            if (cleaned.startsWith('c(') && cleaned.endsWith(')')) {
                cleaned = cleaned.substring(2, cleaned.length - 1);
            }
            return cleaned.split(/",\s*"/).map(s => s.replace(/^"|"$/g, '').replace(/\"/g, '"').replace(/\n/g, ' ').trim());
        }

        function renderMatches(matches, container, isAlmostMatch, currentPage) {
            container.innerHTML = '';

            const startIndex = (currentPage - 1) * recipesPerPage;
            const endIndex = startIndex + recipesPerPage;
            const pageRecipes = matches.slice(startIndex, endIndex);

            if (matches.length === 0) {
                return;
            }

            pageRecipes.forEach(recipe => {
                const card = document.createElement('div');
                card.className = 'bg-white bg-opacity-25 p-6 rounded-lg shadow-lg transform hover:scale-105 transition-transform duration-300 flex flex-col';

                const title = document.createElement('h2');
                title.className = 'text-2xl font-bold text-white mb-4';
                title.textContent = recipe.name;
                card.appendChild(title);

                const ingredientsList = document.createElement('div');
                ingredientsList.className = 'mb-4';
                const ingredientsTitle = document.createElement('h3');
                ingredientsTitle.className = 'font-semibold text-white';
                ingredientsTitle.textContent = 'Ingredients:';
                ingredientsList.appendChild(ingredientsTitle);
                const ul = document.createElement('ul');
                ul.className = 'list-disc list-inside text-gray-200';
                recipe.ingredients.forEach(ingredient => {
                    if(ingredient && ingredient.trim() !== '' && ingredient.trim() !== ',') {
                        const li = document.createElement('li');
                        if (isAlmostMatch && recipe.missingIngredients.map(i => i.toLowerCase()).includes(ingredient.toLowerCase())) {
                            li.innerHTML = `<span class="missing-ingredient">${ingredient}</span>`;
                        } else {
                            li.textContent = ingredient;
                        }
                        ul.appendChild(li);
                    }
                });
                ingredientsList.appendChild(ul);
                card.appendChild(ingredientsList);

                const macrosDiv = document.createElement('div');
                macrosDiv.className = 'mb-4';
                const macrosTitle = document.createElement('h3');
                macrosTitle.className = 'font-semibold text-white';
                macrosTitle.textContent = 'Macronutrients:';
                macrosDiv.appendChild(macrosTitle);
                const macrosP = document.createElement('p');
                macrosP.className = 'text-gray-200';
                macrosP.innerHTML = `
                    <span class="inline-block bg-blue-200 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">Protein: ${Math.round(recipe.protein)}g</span>
                    <span class="inline-block bg-green-200 text-green-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">Carbs: ${Math.round(recipe.carbs)}g</span>
                    <span class="inline-block bg-red-200 text-red-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">Fat: ${Math.round(recipe.fat)}g</span>
                `;
                macrosDiv.appendChild(macrosP);
                card.appendChild(macrosDiv);

                const instructionsDiv = document.createElement('div');
                instructionsDiv.className = 'mb-4 flex-grow';
                const instructionsTitle = document.createElement('h3');
                instructionsTitle.className = 'font-semibold text-white';
                instructionsTitle.textContent = 'Instructions:';
                instructionsDiv.appendChild(instructionsTitle);
                const p = document.createElement('p');
                p.className = 'text-gray-200';
                const instructions = parseInstructions(recipe.instructions);
                p.innerHTML = instructions.join("<br>");
                instructionsDiv.appendChild(p);
                card.appendChild(instructionsDiv);

                const categoriesDiv = document.createElement('div');
                categoriesDiv.className = 'flex flex-wrap gap-2 mt-auto';
                
                if(recipe.diet) {
                    const dietBadge = document.createElement('span');
                    const dietColorClass = categoryColors.diet[recipe.diet] || 'bg-gray-300 text-gray-800';
                    dietBadge.className = `text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full ${dietColorClass}`;
                    dietBadge.textContent = recipe.diet;
                    categoriesDiv.appendChild(dietBadge);
                }

                if(recipe.gluten) {
                    const glutenBadge = document.createElement('span');
                    const glutenValue = recipe.gluten.toLowerCase();
                    const glutenColorClass = categoryColors.gluten[glutenValue] || 'bg-gray-300 text-gray-800';
                    glutenBadge.className = `text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full ${glutenColorClass}`;
                    glutenBadge.textContent = recipe.gluten;
                    categoriesDiv.appendChild(glutenBadge);
                }
                
                if(recipe.category) {
                    const categoryBadge = document.createElement('span');
                    categoryBadge.className = 'text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full bg-yellow-200 text-yellow-800';
                    categoryBadge.textContent = recipe.category;
                    categoriesDiv.appendChild(categoryBadge);
                }

                card.appendChild(categoriesDiv);

                container.appendChild(card);
            });
        }

        function renderPagination(container, currentPage, pageCount, onPageChange) {
            container.innerHTML = '';
            if (pageCount <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.className = 'bg-pink-500 text-white p-2 rounded-lg hover:bg-pink-600 transition-colors mx-1 disabled:bg-gray-400';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    onPageChange(currentPage - 1);
                }
            });
            container.appendChild(prevButton);

            for (let i = 1; i <= pageCount; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = `p-2 rounded-lg mx-1 transition-colors ${currentPage === i ? 'bg-pink-700 text-white' : 'bg-pink-500 text-white hover:bg-pink-600'}`;
                pageButton.addEventListener('click', () => onPageChange(i));
                container.appendChild(pageButton);
            }

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.className = 'bg-pink-500 text-white p-2 rounded-lg hover:bg-pink-600 transition-colors mx-1 disabled:bg-gray-400';
            nextButton.disabled = currentPage === pageCount;
            nextButton.addEventListener('click', () => {
                if (currentPage < pageCount) {
                    onPageChange(currentPage + 1);
                }
            });
            container.appendChild(nextButton);
        }

        function renderAll() {
            renderMatches(currentExactMatches, exactMatchesContainer, false, exactMatchesCurrentPage);
            renderMatches(currentAlmostMatches, almostMatchesContainer, true, almostMatchesCurrentPage);

            const exactPageCount = Math.ceil(currentExactMatches.length / recipesPerPage);
            const almostPageCount = Math.ceil(currentAlmostMatches.length / recipesPerPage);

            renderPagination(exactMatchesPagination, exactMatchesCurrentPage, exactPageCount, (page) => {
                exactMatchesCurrentPage = page;
                renderAll();
            });
            renderPagination(almostMatchesPagination, almostMatchesCurrentPage, almostPageCount, (page) => {
                almostMatchesCurrentPage = page;
                renderAll();
            });

            exactMatchesContainerDiv.style.display = currentExactMatches.length > 0 ? 'block' : 'none';
            almostMatchesContainerDiv.style.display = currentAlmostMatches.length > 0 ? 'block' : 'none';
        }

        function filterAndRenderRecipes() {
            exactMatchesCurrentPage = 1;
            almostMatchesCurrentPage = 1;

            const selectedCategory = categoryFilter.value;
            const selectedDiet = dietFilter.value;
            const selectedGluten = glutenFilter.value;
            const selectedMacro = macroFilter.value;
            const enteredIngredients = ingredientsInput.value.toLowerCase().split(',').map(i => i.trim()).filter(i => i);

            let filteredByDropdowns = recipes.filter(recipe => {
                const categoryMatch = !selectedCategory || recipe.category === selectedCategory;
                const dietMatch = !selectedDiet || recipe.diet === selectedDiet;
                const glutenMatch = !selectedGluten || recipe.gluten.toLowerCase() === selectedGluten;
                const macroMatch = !selectedMacro ||
                    (selectedMacro === 'high-protein' && recipe.protein > 30) ||
                    (selectedMacro === 'low-carb' && recipe.carbs < 20) ||
                    (selectedMacro === 'low-fat' && recipe.fat < 15);
                return categoryMatch && dietMatch && glutenMatch && macroMatch;
            });

            if (enteredIngredients.length === 0) {
                currentExactMatches = filteredByDropdowns.slice(0, 100);
                currentAlmostMatches = [];
                renderAll();
                return;
            }

            let exactMatches = [];
            let almostMatches = [];

            filteredByDropdowns.forEach(recipe => {
                const recipeIngredientsLower = recipe.ingredients.map(i => i.toLowerCase());

                const isExactMatch = recipeIngredientsLower.length === enteredIngredients.length &&
                                     recipeIngredientsLower.every(recipeIng => enteredIngredients.some(ing => recipeIng.includes(ing)));
                
                if (isExactMatch) {
                    exactMatches.push(recipe);
                    return;
                }

                const allEnteredPresent = enteredIngredients.every(ing => recipeIngredientsLower.some(recipeIng => recipeIng.includes(ing)));

                if (allEnteredPresent) {
                    const missingIngredients = recipeIngredientsLower.filter(recipeIng => !enteredIngredients.some(ing => recipeIng.includes(ing)));
                    const missingCount = new Set(missingIngredients).size;

                    if (missingCount > 0 && missingCount <= 5) {
                        recipe.missingIngredients = [...new Set(missingIngredients)];
                        almostMatches.push(recipe);
                    }
                }
            });

            almostMatches.sort((a, b) => a.missingIngredients.length - b.missingIngredients.length);

            currentExactMatches = exactMatches;
            currentAlmostMatches = almostMatches;
            
            renderAll();
        }

        function populateFilters(recipes) {
            const categories = [...new Set(recipes.map(r => r.category))];
            
            categories.sort().forEach(type => {
                if (type && !Array.from(categoryFilter.options).some(o => o.value === type)) {
                    const option = new Option(type.charAt(0).toUpperCase() + type.slice(1), type);
                    categoryFilter.add(option);
                }
            });
        }
        
        async function main() {
            try {
                const response = await fetch('http://localhost:5000/api/recipes');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                recipes = data.recipes;
                populateFilters(recipes);
            } catch (error) {
                console.error("Could not load recipes:", error);
                exactMatchesContainer.innerHTML = '<p class="text-white col-span-full text-center text-xl font-semibold">Error loading recipes. Please ensure the server is running.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', main);

        findRecipesBtn.addEventListener('click', filterAndRenderRecipes);


    </script>

</body>
</html>